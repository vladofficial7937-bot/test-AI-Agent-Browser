# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –Ω–∞ observe()

## üêõ –ü—Ä–æ–±–ª–µ–º–∞:

GigaChat –≤—ã–∑—ã–≤–∞–ª `observe()` **30+ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥** –±–µ–∑ –ø–æ–ª–µ–∑–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:

```
observe ‚Üí observe ‚Üí observe ‚Üí observe ‚Üí ... (x30)
```

---

## üîç –ü—Ä–∏—á–∏–Ω–∞:

1. **GigaChat –≤–æ–∑–≤—Ä–∞—â–∞–ª –ù–ï–°–ö–û–õ–¨–ö–û –¥–µ–π—Å—Ç–≤–∏–π —Å—Ä–∞–∑—É:**
   ```json
   {"type":"tool_call","tool":{"name":"navigate",...}}
   {"type":"tool_call","tool":{"name":"observe"}}
   {"type":"tool_call","tool":{"name":"click",...}}
   ```
   
   –ù–∞—à –ø–∞—Ä—Å–µ—Ä –ø–∞–¥–∞–ª –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 87, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –æ–∂–∏–¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ JSON –æ–±—ä–µ–∫—Ç–æ–≤.

2. **–ü—Ä–æ–º–ø—Ç –±—ã–ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–≥–∏–º** - GigaChat –Ω–µ –ø–æ–Ω–∏–º–∞–ª —á—Ç–æ –Ω—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¢–û–õ–¨–ö–û –û–î–ù–û –¥–µ–π—Å—Ç–≤–∏–µ.

3. **Loop detection –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö observe** - –æ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ:

### 1. –£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–µ—Ä JSON

**–ë—ã–ª–æ:**
```typescript
const parsed = JSON.parse(content); // –ü–∞–¥–∞–ª–æ –Ω–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–º JSON
```

**–°—Ç–∞–ª–æ:**
```typescript
// GigaChat sometimes returns multiple JSON objects on separate lines
// Take only the FIRST valid JSON object
const lines = content.split('\n').filter(line => line.trim());

for (const line of lines) {
  try {
    const parsed = JSON.parse(line.trim());
    if (parsed.type) {
      return parsed as LLMResponse; // –ë–µ—Ä–µ–º –ü–ï–†–í–´–ô –≤–∞–ª–∏–¥–Ω—ã–π
    }
  } catch (e) {
    continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
  }
}
```

### 2. –£–ª—É—á—à–µ–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è GigaChat

**–ë—ã–ª–æ:**
```
You are a fast, efficient web browsing agent.
RESPONSE (JSON ONLY):
...
```

**–°—Ç–∞–ª–æ:**
```
You are a FAST, DECISIVE web agent. Take action immediately.

CRITICAL RULES:
1. Return ONLY ONE action per response (not a list!)
2. After observe(), IMMEDIATELY take action (click/type/navigate)
3. DO NOT call observe() twice in a row - it's wasteful!
4. Use element IDs from the snapshot
5. Be direct - no overthinking

NEVER return multiple actions - only ONE action per turn!
```

### 3. –£–ª—É—á—à–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è

**–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è observe:**

```typescript
// CRITICAL: Detect observe() spam (3+ successful observes in a row)
if (action === 'observe' && !error) {
  const recentObserves = lastActions.slice(-5).filter(a => a === 'observe:success');
  if (recentObserves.length >= 3) {
    console.log('‚ö†Ô∏è Loop detected: observe called 3+ times without action');
    return true; // STOP
  }
}
```

### 4. –£–≤–µ–ª–∏—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è LLM

**–ë—ã–ª–æ:** 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤

**–°—Ç–∞–ª–æ:** 20 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤

–¢–µ–ø–µ—Ä—å LLM **–≤–∏–¥–∏—Ç —Å–≤–æ–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è** –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∏—Ö –±–µ—Å–º—ã—Å–ª–µ–Ω–Ω–æ.

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

### –¢–µ–ø–µ—Ä—å –∞–≥–µ–Ω—Ç:

‚úÖ **–ü–∞—Ä—Å–∏—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã** –æ—Ç GigaChat
‚úÖ **–ë–µ—Ä–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ** –∏–∑ —Å–ø–∏—Å–∫–∞
‚úÖ **–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 3 observe –ø–æ–¥—Ä—è–¥**
‚úÖ **–í–∏–¥–∏—Ç 20 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤** –≤ –∏—Å—Ç–æ—Ä–∏–∏
‚úÖ **–ü–æ–ª—É—á–∞–µ—Ç —á–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏** –Ω–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞—Ç—å—Å—è

---

## üìù –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ** –≤ `chrome://extensions` (–∫–Ω–æ–ø–∫–∞ ‚Üª)
2. **–û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π —Å–∞–π—Ç** (–Ω–µ chrome://)
3. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—á—É:**

### –ü—Ä–æ—Å—Ç–∞—è:
```
–ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ Python
```

### –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤–∞—è:
```
–û—Ç–∫—Ä–æ–π hh.ru –∏ –Ω–∞–π–¥–∏ 3 –≤–∞–∫–∞–Ω—Å–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:

1. `agent-proxy/src/llmClient.ts`
   - –£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–µ—Ä –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö JSON
   - –û–±–Ω–æ–≤–ª–µ–Ω SYSTEM_PROMPT –¥–ª—è —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏
   
2. `src/background/serviceWorker.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ observe() —Å–ø–∞–º
   - –£–≤–µ–ª–∏—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–æ 20 —à–∞–≥–æ–≤

### –°–±–æ—Ä–∫–∞:

```powershell
cd "d:\browser 2.0"
npm run build

cd agent-proxy
npm run build
npm start
```

---

## ‚ö° –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!

**–ê–≥–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ observe() –∏ –¥–µ–ª–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ–∑–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è!** üéØ
